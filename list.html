<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ´»å‹•ä¸€è¦§</title>
  <style>
    :root{
      --brand:#35b8b6;
      --text:#111;
      --muted:#666;
      --bg:#f6f7f8;
      --card:#fff;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP","Segoe UI",Roboto,Arial;
      color:var(--text);
      background:var(--bg);
    }
    header{
      background:var(--brand);
      color:#fff;
      padding:14px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      position:sticky;
      top:0;
      z-index:10;
    }
    header .title{
      font-weight:900;
      letter-spacing:.04em;
      font-size:18px;
      flex:1;
      text-align:center;
    }
    .back{
      appearance:none;border:0;background:rgba(255,255,255,.18);
      color:#fff;border-radius:999px;
      padding:8px 12px;
      font-weight:700;
      cursor:pointer;
    }
    .addTop{
      appearance:none;border:0;background:#fff;color:#0c5c5b;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
    }

    main{max-width:820px;margin:0 auto;padding:14px 12px 26px;}
    .metaRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      margin:8px 2px 12px;
    }
    .meta{color:var(--muted);font-size:13px;}
    .search{
      width: 220px;
      max-width: 45vw;
      border:0;
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
      box-shadow: var(--shadow);
    }

    .list{display:grid;gap:12px;}
    .item{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px;
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .badge{
      width:44px;height:44px;border-radius:12px;
      display:grid;place-items:center;
      background:#eef7f7;color:#116;
      font-size:20px;
      flex:0 0 auto;
    }
    .name{font-weight:900}
    .desc{color:var(--muted);font-size:13px;margin-top:2px}

    .trash{
      appearance:none;
      border:0;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      position:absolute;
      right:12px;
      top:50%;
      transform:translateY(-50%);
      opacity:.75;
    }
    .trash:active{transform:translateY(-50%) scale(.95);}

    .empty{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      color:var(--muted);
    }

    /* ---- Modal ---- */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      box-shadow: 0 18px 40px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px 14px;
      background:#f2fbfb;
      border-bottom:1px solid #e6f2f2;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .closeBtn{
      appearance:none;border:0;background:transparent;
      font-size:22px; cursor:pointer; line-height:1;
    }
    .modalBody{padding:14px 14px 16px; display:grid; gap:10px;}
    label{font-size:12px;color:#444;font-weight:800}
    input, textarea{
      width:100%;
      border:1px solid #e7e7e7;
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:86px; resize:vertical;}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      padding:0 14px 16px;
    }
    .btn{
      appearance:none;border:0;border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{background:var(--brand);color:#fff;}
    .btn.ghost{background:#f2f2f2;color:#111;}
    .note{font-size:12px;color:#666;line-height:1.5;}
  </style>
</head>

<body>
  <header>
    <button class="back" type="button" id="backBtn">â†</button>
    <div class="title" id="pageTitle">æ´»å‹•ä¸€è¦§</div>
    <button class="addTop" type="button" id="addBtn">ï¼‹è¿½åŠ </button>
  </header>

  <main>
    <div class="metaRow">
      <div class="meta" id="meta"></div>
      <input class="search" id="search" type="search" placeholder="æ¤œç´¢ï¼ˆä¾‹ï¼šSSTï¼‰" />
    </div>
    <div class="list" id="list"></div>
  </main>

  <!-- è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHeader">
        <div id="modalTitle">æ´»å‹•ã‚’è¿½åŠ </div>
        <button class="closeBtn" type="button" id="closeBtn">Ã—</button>
      </div>

      <div class="modalBody">
        <div>
          <label>æ´»å‹•å</label>
          <input id="fName" placeholder="ä¾‹ï¼šæ„Ÿæƒ…ã‚«ãƒ¼ãƒ‰ï¼ˆæ°—æŒã¡å½“ã¦ï¼‰" />
        </div>
        <div>
          <label>èª¬æ˜ï¼ˆçŸ­ãï¼‰</label>
          <textarea id="fDesc" placeholder="ä¾‹ï¼šè¡¨æƒ…â†’æ°—æŒã¡â†’ç†ç”±ã€‚SSTã®å°å…¥ã€‚"></textarea>
        </div>

        <div class="row2">
          <div>
            <label>ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
            <input id="fIcon" placeholder="ä¾‹ï¼šğŸ§ " />
          </div>
          <div>
            <label>è©³ç´°ãƒšãƒ¼ã‚¸ç”¨ã®IDï¼ˆç©ºãªã‚‰è‡ªå‹•ï¼‰</label>
            <input id="fId" placeholder="ä¾‹ï¼šfo-999" />
          </div>
        </div>

        <div class="note">
          â€»è¿½åŠ ã—ãŸå†…å®¹ã¯ã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆlocalStorageï¼‰ã€‚<br/>
          â€»ä»–ã®ç«¯æœ«/ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã¯è‡ªå‹•ã§å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" type="button" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" type="button" id="saveBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script>
    // -------------------------------
    // 1) ã‚«ãƒ†ã‚´ãƒªï¼†åˆæœŸãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€å°ä¾‹ï¼‰
    // â€»ã“ã“ã¯ã‚ãªãŸã®108ä»¶ãƒ‡ãƒ¼ã‚¿ã«ç½®ãæ›ãˆã¦OK
    // -------------------------------
    const params = new URLSearchParams(location.search);
    const cat = params.get("cat") || "exercise";

    const categoryName = {
      exercise:"é‹å‹•",
      finger:"æŒ‡å…ˆèª²é¡Œ",
      focus:"é›†ä¸­èª²é¡Œ",
      craft:"å·¥ä½œ",
      cook:"æ–™ç†",
      snack:"ãŠã‚„ã¤ä½œã‚Š",
      rules:"ãƒ«ãƒ¼ãƒ«ã‚²ãƒ¼ãƒ ",
      life:"ç”Ÿæ´»å­¦ç¿’",
      out:"å¤–å‡º",
    };

    // æœ€å°ä¾‹ï¼ˆã‚ãªãŸã®å¤§é‡ãƒ‡ãƒ¼ã‚¿ã«å·®ã—æ›¿ãˆå¯ï¼‰
    const baseActivities = {
      exercise: [
        { id:"ex-001", icon:"ğŸƒ", name:"ã—ã£ã½å–ã‚Šï¼ˆãƒ«ãƒ¼ãƒ«ç°¡æ˜“ï¼‰", desc:"åˆå›³ã§é–‹å§‹/åœæ­¢ã€‚è¡çªã‚’é¿ã‘ã‚‹ç¯„å›²è¨­å®šã¨å½¹å‰²äº¤ä»£ã€‚" },
        { id:"ex-002", icon:"ğŸ§Š", name:"ã‚¹ãƒˆãƒƒãƒ—ï¼†ã‚´ãƒ¼ï¼ˆéŸ³ã§åˆ‡æ›¿ï¼‰", desc:"éŸ³ãŒæ­¢ã¾ã£ãŸã‚‰åœæ­¢ã€‚æŠ‘åˆ¶ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå®Ÿè¡Œæ©Ÿèƒ½ï¼‰ã€‚" },
      ],
      finger: [
        { id:"fi-001", icon:"ğŸ§µ", name:"ã²ã‚‚é€šã—ï¼ˆå¤ªâ†’ç´°ï¼‰", desc:"é›£æ˜“åº¦ã‚’æ®µéšåŒ–ã€‚ä¸¡æ‰‹å”å¿œã¨é›†ä¸­ã‚’è‚²ã¦ã‚‹ã€‚" },
      ],
      focus: [
        { id:"fo-001", icon:"ğŸ§ ", name:"æ„Ÿæƒ…ã‚«ãƒ¼ãƒ‰ï¼ˆæ°—æŒã¡å½“ã¦ï¼‰", desc:"è¡¨æƒ…â†’æ°—æŒã¡â†’ç†ç”±ã€‚SSTã®å°å…¥ã€‚" },
      ],
      craft: [],
      cook: [],
      snack: [],
      rules: [],
      life: [],
      out: [],
    };

    // -------------------------------
    // 2) localStorage æ°¸ç¶šåŒ–
    //   ä¿å­˜ã‚­ãƒ¼ã¯ã‚«ãƒ†ã‚´ãƒªåˆ¥
    // -------------------------------
    const storageKey = (c) => `katsudo_custom_${c}`;

    function loadCustom(c){
      try{
        const raw = localStorage.getItem(storageKey(c));
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function saveCustom(c, arr){
      localStorage.setItem(storageKey(c), JSON.stringify(arr));
    }

    function getAllItems(c){
      const base = baseActivities[c] || [];
      const custom = loadCustom(c);
      return base.concat(custom);
    }

    // -------------------------------
    // 3) UIè¦ç´ 
    // -------------------------------
    const titleEl = document.getElementById("pageTitle");
    const metaEl  = document.getElementById("meta");
    const listEl  = document.getElementById("list");
    const searchEl = document.getElementById("search");

    document.getElementById("backBtn").addEventListener("click", () => history.back());

    const cname = categoryName[cat] || "æ´»å‹•";
    titleEl.textContent = `${cname}ï¼ˆä¸€è¦§ï¼‰`;

    // -------------------------------
    // 4) æç”»
    // -------------------------------
    function render(){
      const q = (searchEl.value || "").trim().toLowerCase();
      const items = getAllItems(cat).filter(a => {
        if(!q) return true;
        const t = `${a.name} ${a.desc}`.toLowerCase();
        return t.includes(q);
      });

      metaEl.textContent = `é¸æŠä¸­ï¼š${cname} ï¼ ${items.length}ä»¶ï¼ˆæ¤œç´¢åæ˜ ï¼‰`;
      listEl.innerHTML = "";

      if(items.length === 0){
        listEl.innerHTML = `<div class="empty">è©²å½“ã™ã‚‹æ´»å‹•ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        return;
      }

      items.forEach(a => {
        const div = document.createElement("div");
        div.className = "item";

        // customåˆ¤å®šï¼ˆcustomé…åˆ—ã«å­˜åœ¨ã™ã‚‹ã‹ï¼‰
        const customArr = loadCustom(cat);
        const isCustom = customArr.some(x => x.id === a.id);

        // è¡Œã‚¯ãƒªãƒƒã‚¯ï¼šè©³ç´°ã¸
        div.addEventListener("click", () => {
          location.href = `action.html?cat=${encodeURIComponent(cat)}&id=${encodeURIComponent(a.id)}`;
        });

        div.innerHTML = `
          <div class="badge" aria-hidden="true">${a.icon || "ğŸ“Œ"}</div>
          <div style="padding-right:36px;">
            <div class="name">${escapeHtml(a.name || "")}</div>
            <div class="desc">${escapeHtml(a.desc || "")}</div>
          </div>
          ${isCustom ? `<button class="trash" type="button" title="å‰Šé™¤">ğŸ—‘ï¸</button>` : ``}
        `;

        // å‰Šé™¤ï¼ˆcustomã®ã¿ï¼‰
        if(isCustom){
          const trashBtn = div.querySelector(".trash");
          trashBtn.addEventListener("click", (ev) => {
            ev.stopPropagation(); // è¡Œã‚¯ãƒªãƒƒã‚¯ã‚’æ­¢ã‚ã‚‹
            if(!confirm("ã“ã®æ´»å‹•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆã“ã®ç«¯æœ«ã®ä¿å­˜åˆ†ã®ã¿ï¼‰")) return;
            const next = customArr.filter(x => x.id !== a.id);
            saveCustom(cat, next);
            render();
          });
        }

        listEl.appendChild(div);
      });
    }

    searchEl.addEventListener("input", render);

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // -------------------------------
    // 5) è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
    // -------------------------------
    const overlay = document.getElementById("overlay");
    const addBtn = document.getElementById("addBtn");
    const closeBtn = document.getElementById("closeBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    const fName = document.getElementById("fName");
    const fDesc = document.getElementById("fDesc");
    const fIcon = document.getElementById("fIcon");
    const fId   = document.getElementById("fId");

    function openModal(){
      overlay.classList.add("show");
      overlay.setAttribute("aria-hidden","false");
      // åˆæœŸå€¤
      fName.value = "";
      fDesc.value = "";
      fIcon.value = "";
      fId.value = "";
      setTimeout(() => fName.focus(), 0);
    }
    function closeModal(){
      overlay.classList.remove("show");
      overlay.setAttribute("aria-hidden","true");
    }

    addBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);

    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    overlay.addEventListener("click", (e) => {
      if(e.target === overlay) closeModal();
    });

    // ä¿å­˜
    saveBtn.addEventListener("click", () => {
      const name = (fName.value || "").trim();
      const desc = (fDesc.value || "").trim();
      const icon = (fIcon.value || "").trim() || "ğŸ“Œ";
      let id = (fId.value || "").trim();

      if(!name){
        alert("æ´»å‹•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        fName.focus();
        return;
      }
      if(!id){
        // è‡ªå‹•IDï¼šcat + timestamp
        id = `${cat}-c-${Date.now()}`;
      }

      // æ—¢å­˜IDãƒã‚§ãƒƒã‚¯ï¼ˆbase + customï¼‰
      const allIds = new Set(getAllItems(cat).map(x => x.id));
      if(allIds.has(id)){
        alert("ãã®IDã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚åˆ¥ã®IDã«ã—ã¦ãã ã•ã„ã€‚");
        fId.focus();
        return;
      }

      const custom = loadCustom(cat);
      custom.push({ id, icon, name, desc, custom:true, createdAt: Date.now() });
      saveCustom(cat, custom);

      closeModal();
      render();
    });

    // åˆå›æç”»
    render();
  </script>
</body>
</html>
